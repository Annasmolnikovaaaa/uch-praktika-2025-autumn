/*!
 * Lightweight cursor helper inspired by Cursor.js
 * Provides a global Cursor class compatible with existing init code.
 */
(function (global) {
  if (global.Cursor) {
    return;
  }

  function clamp(value, min, max) {
    return Math.min(Math.max(value, min), max);
  }

  function Cursor(options) {
    if (!(this instanceof Cursor)) {
      return new Cursor(options);
    }

    var defaults = options || {};
    this.container = defaults.container || document.body;
    this.className = defaults.className || "cursor-helper";
    this.speed = clamp(typeof defaults.speed === "number" ? defaults.speed : 0.15, 0.01, 1);

    this._hoverBindings = [];
    this._createElements();
    this._bindEvents();
    this._loop();
  }

  Cursor.prototype._createElements = function () {
    this.cursor = document.createElement("div");
    this.cursor.className = this.className;

    var dot = document.createElement("span");
    this.cursor.appendChild(dot);

    this.container.appendChild(this.cursor);

    this.position = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    this.target = { x: this.position.x, y: this.position.y };
    this.isVisible = false;
    this.scale = 1;
  };

  Cursor.prototype._setVisible = function () {
    if (!this.isVisible) {
      this.cursor.classList.add("is-visible");
      this.isVisible = true;
    }
  };

  Cursor.prototype._bindEvents = function () {
    var self = this;

    this._moveHandler = function (event) {
      self._setVisible();
      self.target.x = event.clientX;
      self.target.y = event.clientY;
      self._updateVisibilityForTarget(event.target);
    };

    window.addEventListener("mousemove", this._moveHandler, { passive: true });

    this._downHandler = function () {
      self.scale = 0.9;
      self.cursor.classList.add("is-active");
    };
    this._upHandler = function () {
      self.scale = 1;
      self.cursor.classList.remove("is-active");
    };

    document.addEventListener("mousedown", this._downHandler, { passive: true });
    document.addEventListener("mouseup", this._upHandler, { passive: true });

    var selectors = defaultTargets();
    selectors.forEach(function (selector) {
      document.querySelectorAll(selector).forEach(function (element) {
        var enter = function () {
          self.cursor.classList.add("is-hover");
        };
        var leave = function () {
          self.cursor.classList.remove("is-hover");
        };
        element.addEventListener("mouseenter", enter, { passive: true });
        element.addEventListener("mouseleave", leave, { passive: true });
        self._hoverBindings.push({ element: element, enter: enter, leave: leave });
      });
    });
  };

  function defaultTargets() {
    return ["a", "button", ".btn", "[data-cursor='focus']"];
  }

  Cursor.prototype._shouldHideCursor = function (target) {
    if (!target) {
      return false;
    }

    if (target.nodeType !== 1) {
      return this._shouldHideCursor(target.parentNode);
    }

    if (typeof target.closest === "function" && target.closest("[data-cursor='force-custom']")) {
      return false;
    }

    var tag = target.tagName;
    if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT" || target.isContentEditable) {
      return true;
    }

    var cursorStyle = "";
    try {
      cursorStyle = window.getComputedStyle(target).cursor || "";
    } catch (err) {
      cursorStyle = "";
    }

    if (!cursorStyle || cursorStyle === "auto" || cursorStyle === "default") {
      return false;
    }

    return cursorStyle.indexOf("pointer") !== -1 || cursorStyle.indexOf("text") !== -1;
  };

  Cursor.prototype._updateVisibilityForTarget = function (target) {
    if (this._shouldHideCursor(target)) {
      this.cursor.classList.add("is-hidden");
    } else {
      this.cursor.classList.remove("is-hidden");
    }
  };

  Cursor.prototype._loop = function () {
    var self = this;

    var render = function () {
      self.position.x += (self.target.x - self.position.x) * self.speed;
      self.position.y += (self.target.y - self.position.y) * self.speed;

      var offsetX = self.cursor.offsetWidth / 2;
      var offsetY = self.cursor.offsetHeight / 2;
      self.cursor.style.transform =
        "translate3d(" +
        (self.position.x - offsetX) +
        "px, " +
        (self.position.y - offsetY) +
        "px, 0) scale(" +
        self.scale +
        ")";

      self._raf = requestAnimationFrame(render);
    };

    render();
  };

  Cursor.prototype.destroy = function () {
    cancelAnimationFrame(this._raf);
    window.removeEventListener("mousemove", this._moveHandler, { passive: true });
    document.removeEventListener("mousedown", this._downHandler, { passive: true });
    document.removeEventListener("mouseup", this._upHandler, { passive: true });

    this._hoverBindings.forEach(function (binding) {
      binding.element.removeEventListener("mouseenter", binding.enter, { passive: true });
      binding.element.removeEventListener("mouseleave", binding.leave, { passive: true });
    });
    this._hoverBindings = [];

    if (this.cursor && this.cursor.parentNode) {
      this.cursor.parentNode.removeChild(this.cursor);
    }
  };

  global.Cursor = Cursor;
})(window);

